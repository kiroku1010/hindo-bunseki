<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-gram 頻度表</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
            padding: 10px;
            box-sizing: border-box;
        }
        input[type="number"] {
            padding: 5px;
            margin-right: 10px;
            width: 80px;
        }
        button {
            padding: 8px 15px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .error {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .limit-note {
            font-size: 0.9em;
            color: gray;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>N-gram 頻度表ジェネレーター</h1>

        <p class="limit-note">
            ※ 100万文字程度の処理はブラウザの性能に依存し、時間がかかる場合があります。
        </p>

        <h2>1. テキスト入力</h2>
        <textarea id="inputText" placeholder="解析したいテキストを入力してください。ここに100万字程度の文字列を貼り付けます。" rows="10"></textarea>

        <h2>2. N-gram長を指定</h2>
        <label for="nGramLength">連続する文字数 (N):</label>
        <input type="number" id="nGramLength" min="1" value="2">
        <button onclick="analyzeText()">頻度表を生成</button>
        <p id="errorMsg" class="error"></p>

        <h2>3. 頻度表結果</h2>
        <div id="resultTable">
            <p>「頻度表を生成」ボタンを押すと結果が表示されます。</p>
        </div>
    </div>

    <script>
        /**
         * テキストを解析し、N-gramの頻度表を生成・表示する
         */
        function analyzeText() {
            const text = document.getElementById('inputText').value;
            const n = parseInt(document.getElementById('nGramLength').value);
            const resultDiv = document.getElementById('resultTable');
            const errorMsg = document.getElementById('errorMsg');
            
            errorMsg.textContent = '';
            resultDiv.innerHTML = '<p>解析中...</p>';

            if (isNaN(n) || n < 1) {
                errorMsg.textContent = 'エラー: 連続文字数 (N) は1以上の整数を入力してください。';
                resultDiv.innerHTML = '';
                return;
            }

            if (text.length === 0) {
                errorMsg.textContent = 'エラー: 解析するテキストを入力してください。';
                resultDiv.innerHTML = '';
                return;
            }

            // N-gramの頻度をカウント
            const frequencyMap = new Map();
            const maxLen = text.length - n + 1;

            // ループ処理をWeb Workerまたは非同期処理で分離すると
            // 100万文字のような大規模データでもUIフリーズを防げますが、
            // シンプルさのため、ここではメインスレッドで実行します。
            // 処理が重い場合はブラウザが警告を出すことがあります。
            for (let i = 0; i < maxLen; i++) {
                const ngram = text.substring(i, i + n);
                // スペースや記号を無視する場合は、ここでフィルタリングロジックを追加
                // 例: if (ngram.trim().length !== n) continue;

                frequencyMap.set(ngram, (frequencyMap.get(ngram) || 0) + 1);
            }

            // Mapを配列に変換し、頻度の降順でソート
            const sortedFrequencies = Array.from(frequencyMap.entries())
                .sort((a, b) => b[1] - a[1]); // b[1] (頻度) - a[1] (頻度) で降順ソート

            // 結果テーブルのHTMLを生成
            let tableHTML = '<table>';
            tableHTML += '<thead><tr><th>N-gram (連続文字列)</th><th>出現頻度</th></tr></thead>';
            tableHTML += '<tbody>';

            // 上位N件など、表示件数を制限することも可能ですが、ここでは全て表示
            for (const [ngram, count] of sortedFrequencies) {
                tableHTML += `<tr><td>${escapeHTML(ngram)}</td><td>${count}</td></tr>`;
            }

            tableHTML += '</tbody></table>';

            resultDiv.innerHTML = tableHTML;
        }

        /**
         * HTML特殊文字のエスケープ処理
         * @param {string} str - エスケープ対象の文字列
         * @returns {string} エスケープ後の文字列
         */
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                const escape = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return escape[match];
            });
        }
    </script>
    </div>
</body>
</html>
